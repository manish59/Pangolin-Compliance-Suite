{% comment %}
Self-contained YAML Editor Component with built-in CSS and JavaScript

Usage:
1. Include this template where you want the YAML editor to appear
2. No external CSS or JS files are needed
3. Pass the required parameters to customize the editor

Example:
{% include "components/yaml_editor.html" with
    field_name="config_data"
    initial_content=form.config_data.value
    label="Configuration"
    help_text="Enter YAML configuration data"
    required=True
    font_size=16
%}
{% endcomment %}

<div id="{{ field_name }}_container" class="yaml-editor-container" style="margin-bottom: 1.5rem;">
    <!-- Label for the editor -->
    <label for="{{ field_name }}_editor" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
        {{ label|default:"YAML Content" }}
        {% if required %}<span class="text-red-500">*</span>{% endif %}
    </label>

    <!-- Hidden textarea to store the actual form value -->
    <textarea
        name="{{ field_name }}"
        id="{{ field_name }}"
        style="display: none;"
        {% if required %}required{% endif %}
    >{{ initial_content|default:"" }}</textarea>

    <!-- The editor container div -->
    <div
        id="{{ field_name }}_editor"
        style="width: 100%; min-height: 16rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; overflow: hidden; font-family: 'Consolas', 'Monaco', 'Courier New', monospace;"
        data-field-name="{{ field_name }}"
    ></div>

    <!-- Optional help text -->
    {% if help_text %}
    <p style="margin-top: 0.25rem; font-size: 0.75rem; color: #6b7280; font-style: italic;">
        {{ help_text }}
    </p>
    {% endif %}

    <!-- Validation message and buttons -->
    <div style="display: flex; align-items: center; margin-top: 0.5rem; justify-content: space-between;">
        <div id="{{ field_name }}_validation_message" style="min-height: 1.5rem; font-size: 0.75rem;"></div>
        <div style="display: flex; gap: 0.5rem;">
            <button
                type="button"
                id="{{ field_name }}_format"
                style="padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 500; border-radius: 0.25rem; color: #1d4ed8; background-color: #dbeafe; transition: all 0.2s;"
                onmouseover="this.style.backgroundColor='#bfdbfe'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)';"
                onmouseout="this.style.backgroundColor='#dbeafe'; this.style.transform=''; this.style.boxShadow='';"
            >
                Format YAML
            </button>
            <button
                type="button"
                id="{{ field_name }}_validate"
                style="padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 500; border-radius: 0.25rem; color: #047857; background-color: #d1fae5; transition: all 0.2s;"
                onmouseover="this.style.backgroundColor='#a7f3d0'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)';"
                onmouseout="this.style.backgroundColor='#d1fae5'; this.style.transform=''; this.style.boxShadow='';"
            >
                Validate
            </button>
        </div>
    </div>
</div>

<script>
(function() {
    // Immediately-invoked function expression to avoid polluting global scope
    const fieldName = "{{ field_name }}";
    const fontSize = {{ font_size|default:14 }};

    // Initialize editor when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initializeYamlEditor(fieldName, fontSize);
    });

    function initializeYamlEditor(fieldName, fontSize) {
        // Load dependencies if needed
        loadDependencies(function() {
            // Try to create Monaco editor with fallback
            createEditor(fieldName, fontSize);
        });
    }

    function loadDependencies(callback) {
        // Load Monaco if not available
        if (typeof monaco === 'undefined') {
            // First check if require is available
            if (typeof require === 'undefined') {
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js', function() {
                    require.config({
                        paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }
                    });

                    // Check for js-yaml
                    if (typeof jsyaml === 'undefined') {
                        loadScript('https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js', callback);
                    } else {
                        callback();
                    }
                });
            } else {
                // Require exists, configure and load Monaco
                require.config({
                    paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }
                });

                // Check for js-yaml
                if (typeof jsyaml === 'undefined') {
                    loadScript('https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js', callback);
                } else {
                    callback();
                }
            }
        } else if (typeof jsyaml === 'undefined') {
            // Monaco exists but js-yaml doesn't
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js', callback);
        } else {
            // Both dependencies are loaded
            callback();
        }
    }

    function loadScript(url, callback) {
        const script = document.createElement('script');
        script.src = url;
        script.onload = callback;
        script.onerror = function() {
            console.error('Failed to load script:', url);
            // Try to create simple editor if script loading fails
            createSimpleEditor(fieldName, fontSize);
        };
        document.head.appendChild(script);
    }

    function createEditor(fieldName, fontSize) {
        // Set a timeout for Monaco loading
        const timeout = setTimeout(function() {
            console.warn('Monaco editor load timeout - falling back to simple editor');
            createSimpleEditor(fieldName, fontSize);
        }, 5000);

        try {
            // Try to load Monaco
            require(['vs/editor/editor.main'], function() {
                clearTimeout(timeout);

                try {
                    // Get elements
                    const editorContainer = document.getElementById(`${fieldName}_editor`);
                    const textarea = document.getElementById(fieldName);

                    if (!editorContainer || !textarea) {
                        throw new Error('Editor container or textarea not found');
                    }

                    // Create Monaco editor
                    const editor = monaco.editor.create(editorContainer, {
                        value: textarea.value || '{}',
                        language: 'yaml',
                        theme: document.documentElement.classList.contains('dark') ? 'vs-dark' : 'vs',
                        automaticLayout: true,
                        minimap: { enabled: false },
                        lineNumbers: 'on',
                        scrollBeyondLastLine: false,
                        wordWrap: 'on',
                        wrappingIndent: 'indent',
                        tabSize: 2,
                        readOnly: false,
                        fontSize: fontSize,
                        fontFamily: 'Consolas, "Courier New", monospace',
                        fontWeight: 'normal',
                        lineHeight: fontSize * 1.5
                    });

                    // Ensure editor is not readonly
                    editor.updateOptions({ readOnly: false, tabIndex: 0 });

                    // Focus editor
                    setTimeout(() => { editor.focus(); }, 100);

                    // Update textarea when editor content changes
                    editor.onDidChangeModelContent(function() {
                        textarea.value = editor.getValue();
                    });

                    // Setup format and validate buttons
                    setupButtons(fieldName, editor);

                    // Save the editor instance to the container
                    editorContainer.editor = editor;

                } catch (error) {
                    console.error('Error creating Monaco editor:', error);
                    createSimpleEditor(fieldName, fontSize);
                }
            }, function(error) {
                clearTimeout(timeout);
                console.error('Failed to load Monaco editor:', error);
                createSimpleEditor(fieldName, fontSize);
            });
        } catch (error) {
            clearTimeout(timeout);
            console.error('Error initializing Monaco:', error);
            createSimpleEditor(fieldName, fontSize);
        }
    }

    function createSimpleEditor(fieldName, fontSize) {
        console.log(`Setting up simple textarea editor for ${fieldName}`);

        const editorContainer = document.getElementById(`${fieldName}_editor`);
        const hiddenTextarea = document.getElementById(fieldName);

        if (!editorContainer || !hiddenTextarea) {
            console.error('Editor container or textarea not found');
            return;
        }

        // Create a visible textarea
        const visibleTextarea = document.createElement('textarea');
        visibleTextarea.value = hiddenTextarea.value || '{}';
        visibleTextarea.style.width = '100%';
        visibleTextarea.style.height = '100%';
        visibleTextarea.style.minHeight = '16rem';
        visibleTextarea.style.padding = '0.5rem';
        visibleTextarea.style.fontFamily = 'Consolas, "Courier New", monospace';
        visibleTextarea.style.fontSize = `${fontSize}px`;
        visibleTextarea.style.lineHeight = '1.5';
        visibleTextarea.style.border = 'none';
        visibleTextarea.style.outline = 'none';
        visibleTextarea.style.resize = 'vertical';

        // Sync changes to the hidden textarea
        visibleTextarea.addEventListener('input', function() {
            hiddenTextarea.value = visibleTextarea.value;
        });

        // Replace the editor container's content
        editorContainer.innerHTML = '';
        editorContainer.appendChild(visibleTextarea);

        // Setup format and validate buttons
        setupButtons(fieldName, {
            getValue: function() { return visibleTextarea.value; },
            setValue: function(value) {
                visibleTextarea.value = value;
                hiddenTextarea.value = value;
            }
        });

        // Save the editor instance to the container
        editorContainer.editor = {
            type: 'simple',
            element: visibleTextarea,
            getValue: function() { return visibleTextarea.value; },
            setValue: function(value) {
                visibleTextarea.value = value;
                hiddenTextarea.value = value;
            }
        };
    }

    function setupButtons(fieldName, editor) {
        // Get the buttons and validation message element
        const formatButton = document.getElementById(`${fieldName}_format`);
        const validateButton = document.getElementById(`${fieldName}_validate`);
        const validationMsg = document.getElementById(`${fieldName}_validation_message`);

        // Setup format button
        if (formatButton && typeof jsyaml !== 'undefined') {
            formatButton.addEventListener('click', function() {
                try {
                    const content = editor.getValue();
                    const parsedYaml = jsyaml.load(content);
                    const formatted = jsyaml.dump(parsedYaml, {
                        indent: 2,
                        lineWidth: -1,
                        noRefs: true,
                        sortKeys: true
                    });
                    editor.setValue(formatted);
                } catch (e) {
                    if (validationMsg) {
                        validationMsg.textContent = `Error formatting YAML: ${e.message}`;
                        validationMsg.style.color = '#ef4444'; // Red
                    }
                }
            });
        }

        // Setup validate button
        if (validateButton && typeof jsyaml !== 'undefined') {
            validateButton.addEventListener('click', function() {
                try {
                    jsyaml.load(editor.getValue());
                    if (validationMsg) {
                        validationMsg.textContent = 'YAML is valid';
                        validationMsg.style.color = '#10b981'; // Green
                        setTimeout(() => { validationMsg.textContent = ''; }, 3000);
                    }
                } catch (e) {
                    if (validationMsg) {
                        validationMsg.textContent = `YAML error: ${e.message}`;
                        validationMsg.style.color = '#ef4444'; // Red
                    }
                }
            });
        }
    }
})();
</script>